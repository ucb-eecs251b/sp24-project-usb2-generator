# USB2.0: UTMI Integration

# Description
The universal serial bus (USB2.0) is a fast, bi-directional interface that enhances PC connectivity with peripherals. The USB 2.0 Transceiver Macrocell Interface (UTMI) is located within the USB 2.0 Transceiver Macrocell (UTM). 

High-level Interface Information: 
+ Phyiscal Layer Interface (PHY) consists of a 56 pin VQFN
+ Supports up to 480 Mbps transfer rate
+ Configured as 8 bit bidirectional interface

UTMI bridges TX \& RX logic, handling:
+ SYNC and EOP generation on transmit packets and detection on receive packets
+ NRZI encoding and decoding
+ Bit stuffing and unstuffing with error detection
+ Clock domain crossings between USB2.0 data rates and general device logic

# Organization
A rough top-level diagram of the chip is shown below: 

![UTMI TOP diagram](./figs/UTMI_top.png)

A UTMI block contains the following elements:

![UTMI MMIO diagram](./figs/UTMI_MMIO.png)

To the extent possible, the top level will be generated by Chipyard/Hammer.

## Rocket
- A Rocket instance generated by Chipyard
- Communicates with the UTMI block via memory-mapped I/O

## UTMI Block
This block consists of the following pins:
- `clk`: global clock
- `reset`: global reset signal
- `DP`: data plus / USB positive data pin
- `DM`: data minus / USB negatative data pin
- `utmi_clk`: clock for parallel data (30/60 MHz)
- `clk_480`: clock for RX/TX Logic
- `cru_hs_toggle`: specifies mode for RX Logic
- `xcvrSelect`: from SIE, select FS/HS transceivers 
- `opMode`: from SIE, select operational mode 
- `sofDetectSIE`: Start of Frame detection from SIE
- `fsDout`: TX Logic output to analog frontend 
- `seo`: TX Logic output to analog frontend
- `oe`: TX Logic output to analog frontend
- `rpuEn`: TX Logic output to analog frontend
- `hsDout`: TX Logic output to analog frontend
- `hsDriveEn`: TX Logic output to analog frontend
- `hsCurrEn`: TX Logic output to analog frontend
- `mmio_tx_data`: receives data from SIE
- `mmio_tx_ready`: TX Logic ready to receive data
- `mmio_tx_valid`: mmio_tx_data contains valid data
- `mmio_rx_data`: transfers data (containing RxError & RxActive signal) to SIE
- `mmio_rx_ready`: SIE ready to receive data
- `mmio_rx_valid`: mmio_rx_data contains valid data

<!-- This block consists of the following interface signals: TODO table -->

There are four modes of operation:
- HS/FS (30MHz)
- HS/FS (60MHz)
- FS only
- LS only

We currently only support 8 bit unidirectional HS/FS.

### Ready / Valid Interface

#### TX/RX Async Queue
Since the Tilelink system operates at 200MHz, which is different from the frequency specified in the UTMI standard, we employed asynchronous queues between the MMIO registers and the TX/RX logic to cross the different clock domains.
To ensure proper communication and desired behavior of the logic block, the ready-valid signals specified in the UTMI standard are employed between the asynchronous queues and the logic blocks, rather than directly interfacing with the SIE. The status of the queues (full or empty) will be used to handshake with the SIE side.

#### Testing
Chisel Testbench:
A chisel testbench is developed to verify the functionality of the ready-valid handshake and the asynchronous queues. We generate random data sequences, with lengths exceeding the depth of the queues, and validate that the logic block receives the correct data in the expected order.

### MMIO Structure
The MMIO controller exposes the following memory-mapped registers.
| Name     | Width | Direction     | Description         | 
| -------- | ----- | ------------- | ------------------- |
| `rx_bundle` | 10   | RO | (RXError, RXActive, DataOut[7:0]) from RX Logic |
| `utmi_datain` | 8   | WO | DataIn[7:0] to TX |
| `tx_busy` | 1  | RO | TX side is saturated, cannot transmit anymore data |

Widths are specified in bits. For the direction field:

- R/W means the register is readable and writable.
- RO means the register is read-only.
- WO means the register is write-only.

#### Testing
C test:
A comprehensive C test is under development to perform end-to-end testing for the integrated design. The test involves sending data to the UTMI TX block through the MMIO system and verifying that the data is correctly received back at the MMIO system through the UTMI RX block.


## Analog FrontEnd
The majority of the analog frontend has yet to be implemented.

### [Implemented] Data Recovery Circuit
+ Recovered dout to RX

### To be Implemented
+ PLL: 480 MHz
+ DLL: 10-phase clock
+ RX \& TX analog logic

## References
1. [Intel Specification](https://www.intel.com/content/dam/www/public/us/en/documents/technical-specifications/usb2-transceiver-macrocell-interface-specifications.pdf)
2. [Microchip Specification](https://www.microchip.com/en-us/product/usb3250#document-table)
